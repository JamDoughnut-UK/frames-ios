format_version: "8"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
workflows:
  _frames-set-up:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - cache-pull@2: {}
    - certificate-and-profile-installer@1: {}
    after_run: []

  _run-regression-tests:
    steps:
    - xcode-test:
        inputs:
        - project_path: $FRAMES_SPM_PROJECT
        - scheme: $FRAMES_REGRESSION_TEST_SCHEME
        - destination: platform=iOS Simulator,name=iPhone 14 Pro,OS=latest
        - simulator_device: $UITEST_SIMULATOR_DEVICE
    - deploy-to-bitrise-io@2.3: {}
    - cache-push@2: {}

  frames-deploy:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - cache-pull@2: {}
    - certificate-and-profile-installer@1: {}
    - cocoapods-install@2.2:
        inputs:
        - podfile_path: $FRAMES_PODFILE
    - xcode-test:
        inputs:
        - project_path: $FRAMES_COCOAPODS_PROJECT
        - scheme: $FRAMES_APP_SCHEME
    - xcode-archive@2:
        inputs:
        - project_path: $FRAMES_COCOAPODS_PROJECT
        - scheme: $FRAMES_APP_SCHEME
        - export_method: $BITRISE_EXPORT_METHOD
    - deploy-to-bitrise-io@1: {}
    - cache-push@2: {}

  frames-playground:
    steps:
    - xcode-test:
        inputs:
        - project_path: $FRAMES_SPM_PROJECT
        - scheme: $FRAMES_APP_SCHEME
    - deploy-to-bitrise-io@1: {}
    - cache-push@2: {}
    - slack@3:
        inputs:
        - webhook_url: $FRAMES_IOS_BUILDS_CHANNEL

  frames-regression-tests:
    after_run:
    - _frames-set-up
    - _run-regression-tests
    
app:
  envs:
  - opts:
      is_expand: false
    UITEST_SIMULATOR_DEVICE: iPhone 14 Pro
  - opts:
      is_expand: false
    BITRISE_EXPORT_METHOD: development
  - opts:
      is_expand: false
    BITRISE_DISTRIBUTION_METHOD: development

  - opts:
      is_expand: false
    FRAMES_PODFILE: iOS Example Frame/Podfile
  - opts:
      is_expand: false
    FRAMES_COCOAPODS_PROJECT: iOS Example Frame/iOS Example Frame.xcworkspace
  - opts:
      is_expand: false
    FRAMES_SPM_PROJECT: iOS Example Frame SPM/iOS Example Frame SPM.xcodeproj
  - opts:
      is_expand: false
    FRAMES_APP_SCHEME: iOS Example Frame
  - opts:
      is_expand: false
    FRAMES_UITEST_SCHEME: UITest
  - opts:
      is_expand: false
    FRAMES_REGRESSION_TEST_SCHEME: Regression Tests
  - opts:
      is_expand: false
    FRAMES_TEST_SCHEME: FramesTests
  - opts:
      is_expand: false
    CHECKOUT_PODFILE: Checkout/Samples/CocoapodsSample/Podfile
  - opts:
      is_expand: false
    CHECKOUT_SPM_PROJECT: Checkout/Samples/SPMSample/CheckoutSPMSample.xcodeproj
  - opts:
      is_expand: false
    CHECKOUT_APP_SCHEME: CheckoutSPMSample
  - opts:
      is_expand: false
    CHECKOUT_TEST_SCHEME: CheckoutTests

meta:
  bitrise.io:
    stack: osx-xcode-14.3.x-ventura
    machine_type_id: g2-m1.4core
